{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth != null && (auth.uid == $uid || root.child('users').child(auth.uid).child('role').val() == 'teacher')",
        ".write": "auth != null && ((!data.exists() && auth.uid == $uid) || (auth.uid == $uid && !newData.child('role').exists()))",
        ".validate": "newData.hasChildren(['email', 'username', 'role', 'uid'])",
        "email": {
          ".validate": "newData.isString() && newData.val().matches(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/)"
        },
        "username": {
          ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 30"
        },
        "role": {
          ".validate": "newData.isString() && (newData.val() == 'student' || newData.val() == 'teacher') && (!data.exists() || data.val() == newData.val())"
        },
        "uid": {
          ".validate": "newData.val() == $uid"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        }
      }
    }
    ,
    "classes": {
      "$classId": {
        ".read": "auth != null && root.child('classes').child($classId).child('teacherUid').val() == auth.uid",
        ".write": "auth != null && (data.exists() ? root.child('classes').child($classId).child('teacherUid').val() == auth.uid : newData.child('teacherUid').val() == auth.uid)",
        ".validate": "newData.hasChildren(['name','teacherUid','createdAt'])",
        "name": {
          ".validate": "newData.isString() && newData.val().length > 1"
        },
        "teacherUid": {
          ".validate": "newData.val() == auth.uid"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        }
      }
    }
  }
}